<!doctype html><html lang=fr dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Amélioration du "post script" de backup-manager | ::franek::</title>
<meta name=keywords content="geek,backup,backup-manager,hook,linux,sauvegarde"><meta name=description content="backup-manager est un script très pratique permettant de faire la sauvegarde d&rsquo;un serveur dédié. Ce script est utilisé pour effectuer la sauvegarde de la dédibox qui héberge ce site et ces satellites. Par défaut, ce script ne propose pas de contrôle des fichiers déposés sur le serveur de sauvegarde ou d&rsquo;envoi d&rsquo;un email lors de la fin de l&rsquo;exécution de la sauvegarde.
Il est possible d&rsquo;ajouter des fonctionnalités à ce script via des hooks exécutés avant ou après la sauvegarde. Alsacréations propose un exemple de hook permettant d&rsquo;envoyer un mail à la fin de l&rsquo;exécution de la sauvegarde. Malheureusement, ce script ne vérifie pas que les fichiers ont bien été déposés sur le serveur de sauvegarde et que les fichiers sont bien complets. Ce script n&rsquo;est utile que si la méthode d&rsquo;upload est FTP. Dans le cadre d&rsquo;une autre méthode d&rsquo;upload (rsync, par exemple), le contrôle peut être exécuté nativement."><meta name=author content="franek"><link rel=canonical href=https://franek.chicour.net/post/amelioration-du-post-script-de-backup-manager/><meta name=google-site-verification content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://franek.chicour.net/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://franek.chicour.net/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://franek.chicour.net/favicon-32x32.png><link rel=apple-touch-icon href=https://franek.chicour.net/apple-touch-icon.png><link rel=mask-icon href=https://franek.chicour.net/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=fr href=https://franek.chicour.net/post/amelioration-du-post-script-de-backup-manager/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://franek.chicour.net/post/amelioration-du-post-script-de-backup-manager/"><meta property="og:site_name" content="::franek::"><meta property="og:title" content='Amélioration du "post script" de backup-manager'><meta property="og:description" content="backup-manager est un script très pratique permettant de faire la sauvegarde d’un serveur dédié. Ce script est utilisé pour effectuer la sauvegarde de la dédibox qui héberge ce site et ces satellites. Par défaut, ce script ne propose pas de contrôle des fichiers déposés sur le serveur de sauvegarde ou d’envoi d’un email lors de la fin de l’exécution de la sauvegarde.
Il est possible d’ajouter des fonctionnalités à ce script via des hooks exécutés avant ou après la sauvegarde. Alsacréations propose un exemple de hook permettant d’envoyer un mail à la fin de l’exécution de la sauvegarde. Malheureusement, ce script ne vérifie pas que les fichiers ont bien été déposés sur le serveur de sauvegarde et que les fichiers sont bien complets. Ce script n’est utile que si la méthode d’upload est FTP. Dans le cadre d’une autre méthode d’upload (rsync, par exemple), le contrôle peut être exécuté nativement."><meta property="og:locale" content="fr"><meta property="og:type" content="article"><meta property="article:section" content="post"><meta property="article:published_time" content="2009-12-29T22:20:00+01:00"><meta property="article:modified_time" content="2010-08-17T13:36:24+02:00"><meta property="article:tag" content="Geek"><meta property="article:tag" content="Backup"><meta property="article:tag" content="Backup-Manager"><meta property="article:tag" content="Hook"><meta property="article:tag" content="Linux"><meta property="article:tag" content="Sauvegarde"><meta name=twitter:card content="summary"><meta name=twitter:title content='Amélioration du "post script" de backup-manager'><meta name=twitter:description content="backup-manager est un script très pratique permettant de faire la sauvegarde d&rsquo;un serveur dédié. Ce script est utilisé pour effectuer la sauvegarde de la dédibox qui héberge ce site et ces satellites. Par défaut, ce script ne propose pas de contrôle des fichiers déposés sur le serveur de sauvegarde ou d&rsquo;envoi d&rsquo;un email lors de la fin de l&rsquo;exécution de la sauvegarde.
Il est possible d&rsquo;ajouter des fonctionnalités à ce script via des hooks exécutés avant ou après la sauvegarde. Alsacréations propose un exemple de hook permettant d&rsquo;envoyer un mail à la fin de l&rsquo;exécution de la sauvegarde. Malheureusement, ce script ne vérifie pas que les fichiers ont bien été déposés sur le serveur de sauvegarde et que les fichiers sont bien complets. Ce script n&rsquo;est utile que si la méthode d&rsquo;upload est FTP. Dans le cadre d&rsquo;une autre méthode d&rsquo;upload (rsync, par exemple), le contrôle peut être exécuté nativement."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://franek.chicour.net/post/"},{"@type":"ListItem","position":2,"name":"Amélioration du \"post script\" de backup-manager","item":"https://franek.chicour.net/post/amelioration-du-post-script-de-backup-manager/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Amélioration du \"post script\" de backup-manager","name":"Amélioration du \u0022post script\u0022 de backup-manager","description":"backup-manager est un script très pratique permettant de faire la sauvegarde d\u0026rsquo;un serveur dédié. Ce script est utilisé pour effectuer la sauvegarde de la dédibox qui héberge ce site et ces satellites. Par défaut, ce script ne propose pas de contrôle des fichiers déposés sur le serveur de sauvegarde ou d\u0026rsquo;envoi d\u0026rsquo;un email lors de la fin de l\u0026rsquo;exécution de la sauvegarde.\nIl est possible d\u0026rsquo;ajouter des fonctionnalités à ce script via des hooks exécutés avant ou après la sauvegarde. Alsacréations propose un exemple de hook permettant d\u0026rsquo;envoyer un mail à la fin de l\u0026rsquo;exécution de la sauvegarde. Malheureusement, ce script ne vérifie pas que les fichiers ont bien été déposés sur le serveur de sauvegarde et que les fichiers sont bien complets. Ce script n\u0026rsquo;est utile que si la méthode d\u0026rsquo;upload est FTP. Dans le cadre d\u0026rsquo;une autre méthode d\u0026rsquo;upload (rsync, par exemple), le contrôle peut être exécuté nativement.\n","keywords":["geek","backup","backup-manager","hook","linux","sauvegarde"],"articleBody":"backup-manager est un script très pratique permettant de faire la sauvegarde d’un serveur dédié. Ce script est utilisé pour effectuer la sauvegarde de la dédibox qui héberge ce site et ces satellites. Par défaut, ce script ne propose pas de contrôle des fichiers déposés sur le serveur de sauvegarde ou d’envoi d’un email lors de la fin de l’exécution de la sauvegarde.\nIl est possible d’ajouter des fonctionnalités à ce script via des hooks exécutés avant ou après la sauvegarde. Alsacréations propose un exemple de hook permettant d’envoyer un mail à la fin de l’exécution de la sauvegarde. Malheureusement, ce script ne vérifie pas que les fichiers ont bien été déposés sur le serveur de sauvegarde et que les fichiers sont bien complets. Ce script n’est utile que si la méthode d’upload est FTP. Dans le cadre d’une autre méthode d’upload (rsync, par exemple), le contrôle peut être exécuté nativement.\nJ’ai donc adapté le script d’alsacréations.\n#!/usr/bin/php \u003c?php /** * backup-manager post script : * - permet de vérifier l'intégrité des fichiers uploadés sur le serveur de sauvegarde * (comparaison des chaines md5) * - envoie d'un mail récapitulatif contenant la liste des fichiers et la taille totale utilisée * * @references script inspiré de Alsacréation : http://www.alsacreations.com/tuto/lire/618-Sauvegarde-backup-manager.html * @autor Franek */ /** * Configuration */ # email des destinataires $email_dest = array(dest@domain.com'); # répertoire local de stockage des fichiers de sauvegarde $archives_dir = '/var/archives'; # adresse du serveur FTP $ftp_server = ''; # identifiant du serveur FTP $ftp_user_name = ''; # mot de passe du serveur FTP $ftp_user_pass = ''; /** * Ne pas modifier - ci-dessous */ /** * * Envoi d'un mail * * @param array $email_dest * @param string $subject * @param string $content */ function sendMail($email_dest, $subject, $content) { foreach($email_dest as $dest) { mail($dest, $subject, $content); } } /** * Récupère la liste des fichiers présents en local pour une date donnée * @param $archives_dir string répertoire de stockage des fichiers * @param $filtre_date string date à filtrer (format YYYYMMDD) * @return array */ function getLocalFiles($archives_dir, $filtre_date) { clearstatcache(); $files = array(); foreach (new DirectoryIterator($archives_dir) as $file_info) { if($file_info-\u003eisDot() || !preg_match('/'.date('Ymd').'/',$file_info-\u003egetFileName())) { continue; } $file['name'] = $file_info-\u003egetFilename(); // on utilise cette commande car filesize ne gère pas les fichiers de plus de 2Go. $file['size'] = exec(\"stat -c %s '\".$file_info-\u003egetPathname().\"'\"); $files[] = $file; }\tsort($files); return $files; } /** * * Compare le hachage md5 des fichiers locaux avec les fichiers envoyés * sur le serveur FTP * Si le hachage est identique, renvoie true. * Sinon, renvoie false * * @param string $md5_file * @param string $ftp_server * @param string $ftp_user_name * @param string $ftp_user_pass * @param string $filtre_date * @return bool */ function verifMd5Ftp($md5_file, $ftp_server, $ftp_user_name, $ftp_user_pass, $filtre_date) { $handle = fopen($md5_file, \"r\"); if ($handle !== false) { while (!feof($handle)) { $buffer = fgets($handle, 4096); list($md5, $filename) = explode(\" \", $buffer); // pour supprimer /n $filename = trim($filename); if (!empty($filename)) { if ($md5 !== getMd5OverFtp($filename, $ftp_server, $ftp_user_name, $ftp_user_pass)) { fclose($handle); return false; } } } fclose($handle); } else { return false; } return true; } /** * * Renvoie le hachage md5 d'un fichier présent sur le serveur FTP de sauvegarde * * @param string $file fichier dont le md5 doit être calculé * @param string $ftp_server adresse du serveur FTP de sauvegarde * @param string $ftp_user_name identifiant de connexion du serveur FTP * @param string $ftp_user_pass mot de passe de connexion du serveur FTP * @return string */ function getMd5OverFtp($file, $ftp_server, $ftp_user_name, $ftp_user_pass) { $connect_string = 'ftp://'; $connect_string .= $ftp_user_name; if (!empty($ftp_user_pass)) { $connect_string .= ':'.$ftp_user_pass; } $connect_string .= '@'.$ftp_server; $connect_string .= '/'.$file; return md5_file($connect_string); } /** * Renvoie la taille du fichier en un format compréhensif * * source : http://fr.php.net/manual/en/function.filesize.php (nak5ive at DONT-SPAM-ME dot gmail dot com) * * @param int $bytes * @param int $precision * @return string */ function formatBytes($bytes, $precision = 2) { $units = array('B', 'KB', 'MB', 'GB', 'TB'); $bytes = max($bytes, 0); $pow = floor(($bytes ? log($bytes) : 0) / log(1024)); $pow = min($pow, count($units) - 1); $bytes /= pow(1024, $pow); return round($bytes, $precision) . ' ' . $units[$pow]; } /** * début du script */ $date = date('Ymd'); $host = trim(file_get_contents('/etc/hostname')); # fichier contenant les chaines md5 de tous les fichiers sauvegardés $md5_file = $archives_dir.'/'.$host.'-'.$date.'.md5'; $check_md5_ftp = false; clearstatcache(); $local_files = getLocalFiles($archives_dir, $date); if(empty($local_files)) { $output .= ' - Fichiers non présents en local (attention : cela peut venir d\\'un problème de droit).'.\"\\n\"; } else { $output .= ' - Fichiers présents en local :'.\"\\n\\n\"; $total_size = 0; // affichage de la liste des fichiers avec leur taille et un total global foreach($local_files as $file) { $output .= ' # '.$file['name']; $output .= ' ('.formatBytes($file['size']).')'; $output .= \"\\n\"; $total_size += $file['size']; } $output .= \"\\n\".' # TOTAL : '.formatBytes($total_size).\"\\n\\n\"; // lance la vérification md5 des fichiers uploadés sur le serveur FTP $check_md5_ftp = verifMd5Ftp($md5_file, $ftp_server, $ftp_user_name, $ftp_user_pass, $filtre_date); if ($check_md5_ftp === false) { $output .= ' - problème d\\'intégrité dans les fichiers transmis sur le serveur FTP'.\"\\n\"; } else { $output .= ' - intégrité des fichiers sur le serveur FTP vérifiés.'.\"\\n\"; } } // construction du sujet du mail $subject = '['.$host.']'; if ($check_md5_ftp === true) { $subject .= ' backup ok'; } else { $subject .= ' backup ko'; } sendMail($email_dest, $subject, $output); ?\u003e Vous pouvez copier ce script dans /etc/backup-manager-post.php et lui donner les droits :\nchmod +x /etc/backup-manager-post.php Pour ajouter le hook à backup-manager, vous devez modifier le fichier de configuration /etc/backup-manager.conf et ajouter :\nexport BM_POST_BACKUP_COMMAND=\"/etc/backup-manager-post.php\" ","wordCount":"2300","inLanguage":"fr","datePublished":"2009-12-29T22:20:00+01:00","dateModified":"2010-08-17T13:36:24+02:00","author":[{"@type":"Person","name":"franek"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://franek.chicour.net/post/amelioration-du-post-script-de-backup-manager/"},"publisher":{"@type":"Organization","name":"::franek::","logo":{"@type":"ImageObject","url":"https://franek.chicour.net/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://franek.chicour.net/ accesskey=h title="::franek:: (Alt + H)"><img src=https://franek.chicour.net/public/logo-franek.png alt aria-label=logo height=35>::franek::</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://franek.chicour.net/tags/ title=Tags><span>Tags</span></a></li><li><a href=https://franek.chicour.net/archive/ title=Archives><span>Archives</span></a></li><li><a href=https://franek.chicour.net/search/ title="Recherche (Alt + /)" accesskey=/><span>Recherche</span></a></li><li><a href=https://franek.chicour.net/feed/rss2 title=RSS><span>RSS</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Amélioration du "post script" de backup-manager</h1><div class=post-meta><span title='2009-12-29 22:20:00 +0100 +0100'>décembre 29, 2009</span>&nbsp;·&nbsp;franek</div></header><div class=post-content><p><a href=http://www.backup-manager.org/>backup-manager</a> est un script très pratique permettant de faire la sauvegarde d&rsquo;un serveur dédié. Ce script est utilisé pour effectuer la sauvegarde de la dédibox qui héberge <a href=http://franek.chicour.net>ce site</a> et <a href=http://www.chicour.net>ces satellites</a>. Par défaut, ce script ne propose pas de contrôle des fichiers déposés sur le serveur de sauvegarde ou d&rsquo;envoi d&rsquo;un email lors de la fin de l&rsquo;exécution de la sauvegarde.</p><p>Il est possible d&rsquo;ajouter des fonctionnalités à ce script via des hooks exécutés avant ou après la sauvegarde. <a href=http://www.alsacreations.com>Alsacréations</a> propose un <a href=http://www.alsacreations.com/tuto/lire/618-Sauvegarde-backup-manager.html>exemple de hook</a> permettant d&rsquo;envoyer un mail à la fin de l&rsquo;exécution de la sauvegarde. Malheureusement, ce script ne vérifie pas que les fichiers ont bien été déposés sur le serveur de sauvegarde et que les fichiers sont bien complets. Ce script n&rsquo;est utile que si la méthode d&rsquo;upload est FTP. Dans le cadre d&rsquo;une autre méthode d&rsquo;upload (rsync, par exemple), le contrôle peut être exécuté nativement.</p><p>J&rsquo;ai donc adapté le script d&rsquo;alsacréations.</p><pre tabindex=0><code>&lt;pre class=&#34;php php&#34; style=&#34;font-family:inherit&#34;&gt;#!/usr/bin/php
&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;&lt;?php&lt;/span&gt;
&lt;span style=&#34;color: #009933; font-style: italic;&#34;&gt;/**
 * backup-manager post script :
 *  - permet de vérifier l&#39;intégrité des fichiers uploadés sur le serveur de sauvegarde
 *    (comparaison des chaines md5)
 *  - envoie d&#39;un mail récapitulatif contenant la liste des fichiers et la taille totale utilisée
 *
 * @references script inspiré de Alsacréation : http://www.alsacreations.com/tuto/lire/618-Sauvegarde-backup-manager.html
 * @autor Franek &lt;franek at chicour dot net&gt;
 */&lt;/span&gt;
 
&lt;span style=&#34;color: #009933; font-style: italic;&#34;&gt;/**
 * Configuration
 */&lt;/span&gt;
&lt;span style=&#34;color: #666666; font-style: italic;&#34;&gt;# email des destinataires
&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$email_dest&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;array&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;dest&lt;span style=&#34;color: #339933;&#34;&gt;@&lt;/span&gt;domain&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;com&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;);
# répertoire local de stockage des fichiers de sauvegarde
$archives_dir = &#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;/&lt;/span&gt;&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;var&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;/&lt;/span&gt;archives&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;;
# adresse du serveur FTP
$ftp_server = &#39;&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;;
# identifiant du serveur FTP
$ftp_user_name = &#39;&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;;
# mot de passe du serveur FTP
$ftp_user_pass = &#39;&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;;
 
/**
 * Ne pas modifier - ci-dessous
 */
 
/**
 *
 * Envoi d&#39;&lt;/span&gt;un &lt;span style=&#34;color: #990000;&#34;&gt;mail&lt;/span&gt;
 &lt;span style=&#34;color: #339933;&#34;&gt;*&lt;/span&gt;
 &lt;span style=&#34;color: #339933;&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;@&lt;/span&gt;param &lt;span style=&#34;color: #990000;&#34;&gt;array&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$email_dest&lt;/span&gt;
 &lt;span style=&#34;color: #339933;&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;@&lt;/span&gt;param string &lt;span style=&#34;color: #000088;&#34;&gt;$subject&lt;/span&gt;
 &lt;span style=&#34;color: #339933;&#34;&gt;*&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;@&lt;/span&gt;param string &lt;span style=&#34;color: #000088;&#34;&gt;$content&lt;/span&gt;
 &lt;span style=&#34;color: #339933;&#34;&gt;*/&lt;/span&gt;
&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;function&lt;/span&gt; sendMail&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$email_dest&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$subject&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$content&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #b1b100;&#34;&gt;foreach&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$email_dest&lt;/span&gt; &lt;span style=&#34;color: #b1b100;&#34;&gt;as&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$dest&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
    &lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
        &lt;span style=&#34;color: #990000;&#34;&gt;mail&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$dest&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$subject&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$content&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
 
&lt;span style=&#34;color: #009933; font-style: italic;&#34;&gt;/**
 * Récupère la liste des fichiers présents en local pour une date donnée
 * @param $archives_dir string répertoire de stockage des fichiers
 * @param $filtre_date string date à filtrer (format YYYYMMDD)
 * @return array
 */&lt;/span&gt;
&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;function&lt;/span&gt; getLocalFiles&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$archives_dir&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$filtre_date&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #990000;&#34;&gt;clearstatcache&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
 
	&lt;span style=&#34;color: #000088;&#34;&gt;$files&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;array&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;foreach&lt;/span&gt; &lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;new&lt;/span&gt; DirectoryIterator&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$archives_dir&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #b1b100;&#34;&gt;as&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$file_info&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	    &lt;span style=&#34;color: #b1b100;&#34;&gt;if&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$file_info&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;-&gt;&lt;/span&gt;&lt;span style=&#34;color: #004000;&#34;&gt;isDot&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;||&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color: #990000;&#34;&gt;preg_match&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;/&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #990000;&#34;&gt;date&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;Ymd&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;/&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$file_info&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;-&gt;&lt;/span&gt;&lt;span style=&#34;color: #004000;&#34;&gt;getFileName&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
	    &lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #b1b100;&#34;&gt;continue&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
	    &lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;name&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$file_info&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;-&gt;&lt;/span&gt;&lt;span style=&#34;color: #004000;&#34;&gt;getFilename&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	    &lt;span style=&#34;color: #666666; font-style: italic;&#34;&gt;// on utilise cette commande car filesize ne gère pas les fichiers de plus de 2Go.&lt;/span&gt;
            &lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;size&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;exec&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;stat -c &lt;span style=&#34;color: #009933; font-weight: bold;&#34;&gt;%s&lt;/span&gt; &#39;&#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$file_info&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;-&gt;&lt;/span&gt;&lt;span style=&#34;color: #004000;&#34;&gt;getPathname&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;&#39;&#34;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
            &lt;span style=&#34;color: #000088;&#34;&gt;$files&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;]&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;	
	&lt;span style=&#34;color: #990000;&#34;&gt;sort&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$files&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$files&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
 
&lt;span style=&#34;color: #009933; font-style: italic;&#34;&gt;/**
 *
 * Compare le hachage md5 des fichiers locaux avec les fichiers envoyés
 * sur le serveur FTP
 * Si le hachage est identique, renvoie true.
 * Sinon, renvoie false
 *
 * @param string $md5_file
 * @param string $ftp_server
 * @param string $ftp_user_name
 * @param string $ftp_user_pass
 * @param string $filtre_date
 * @return bool
 */&lt;/span&gt;
&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;function&lt;/span&gt; verifMd5Ftp&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$md5_file&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_server&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_name&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_pass&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$filtre_date&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$handle&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;fopen&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$md5_file&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;r&#34;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$handle&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;!==&lt;/span&gt; &lt;span style=&#34;color: #009900; font-weight: bold;&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
        &lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #b1b100;&#34;&gt;while&lt;/span&gt; &lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color: #990000;&#34;&gt;feof&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$handle&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt; 
		&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	        	&lt;span style=&#34;color: #000088;&#34;&gt;$buffer&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;fgets&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$handle&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #cc66cc;&#34;&gt;4096&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	        	&lt;span style=&#34;color: #990000;&#34;&gt;list&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$md5&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$filename&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;explode&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;  &#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$buffer&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
			&lt;span style=&#34;color: #666666; font-style: italic;&#34;&gt;// pour supprimer /n&lt;/span&gt;
			&lt;span style=&#34;color: #000088;&#34;&gt;$filename&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;trim&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$filename&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
			&lt;span style=&#34;color: #b1b100;&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color: #990000;&#34;&gt;empty&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$filename&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
			&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
				&lt;span style=&#34;color: #b1b100;&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$md5&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;!==&lt;/span&gt; getMd5OverFtp&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$filename&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_server&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_name&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_pass&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
				&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
					&lt;span style=&#34;color: #990000;&#34;&gt;fclose&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$handle&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
					&lt;span style=&#34;color: #b1b100;&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #009900; font-weight: bold;&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
				&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
			&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
		&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color: #990000;&#34;&gt;fclose&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$handle&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
        &lt;span style=&#34;color: #b1b100;&#34;&gt;else&lt;/span&gt;
        &lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
            &lt;span style=&#34;color: #b1b100;&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #009900; font-weight: bold;&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #009900; font-weight: bold;&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
 
&lt;span style=&#34;color: #009933; font-style: italic;&#34;&gt;/**
 *
 * Renvoie le hachage md5 d&#39;un fichier présent sur le serveur FTP de sauvegarde
 *
 * @param string $file fichier dont le md5 doit être calculé
 * @param string $ftp_server adresse du serveur FTP de sauvegarde
 * @param string $ftp_user_name identifiant de connexion du serveur FTP
 * @param string $ftp_user_pass mot de passe de connexion du serveur FTP
 * @return string
 */&lt;/span&gt;
&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;function&lt;/span&gt; getMd5OverFtp&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_server&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_name&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_pass&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$connect_string&lt;/span&gt;  &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;ftp://&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$connect_string&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_name&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;!&lt;/span&gt;&lt;span style=&#34;color: #990000;&#34;&gt;empty&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_pass&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #000088;&#34;&gt;$connect_string&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;:&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_pass&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$connect_string&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;@&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$ftp_server&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$connect_string&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;/&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;md5_file&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$connect_string&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
 
 
&lt;span style=&#34;color: #009933; font-style: italic;&#34;&gt;/**
 * Renvoie la taille du fichier en un format compréhensif
 *
 * source : http://fr.php.net/manual/en/function.filesize.php (nak5ive at DONT-SPAM-ME dot gmail dot com)
 *
 * @param int $bytes
 * @param int $precision
 * @return string
 */&lt;/span&gt;
&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;function&lt;/span&gt; formatBytes&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$bytes&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$precision&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #cc66cc;&#34;&gt;2&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
    &lt;span style=&#34;color: #000088;&#34;&gt;$units&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;array&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;B&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;KB&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;MB&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;GB&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;TB&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
 
    &lt;span style=&#34;color: #000088;&#34;&gt;$bytes&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;max&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$bytes&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #cc66cc;&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color: #000088;&#34;&gt;$pow&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;floor&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$bytes&lt;/span&gt; ? &lt;span style=&#34;color: #990000;&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$bytes&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color: #cc66cc;&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;/&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;log&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #cc66cc;&#34;&gt;1024&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
    &lt;span style=&#34;color: #000088;&#34;&gt;$pow&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;min&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$pow&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;count&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$units&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;-&lt;/span&gt; &lt;span style=&#34;color: #cc66cc;&#34;&gt;1&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
 
    &lt;span style=&#34;color: #000088;&#34;&gt;$bytes&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;/=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;pow&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #cc66cc;&#34;&gt;1024&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$pow&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
 
    &lt;span style=&#34;color: #b1b100;&#34;&gt;return&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;round&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$bytes&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$precision&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39; &#39;&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$units&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$pow&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
 
 
&lt;span style=&#34;color: #009933; font-style: italic;&#34;&gt;/**
 * début du script
 */&lt;/span&gt;
&lt;span style=&#34;color: #000088;&#34;&gt;$date&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;date&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;Ymd&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #000088;&#34;&gt;$host&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #990000;&#34;&gt;trim&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #990000;&#34;&gt;file_get_contents&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;/etc/hostname&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #666666; font-style: italic;&#34;&gt;# fichier contenant les chaines md5 de tous les fichiers sauvegardés
&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$md5_file&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$archives_dir&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;/&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$host&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;-&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$date&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;.md5&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #000088;&#34;&gt;$check_md5_ftp&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #009900; font-weight: bold;&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
 
&lt;span style=&#34;color: #990000;&#34;&gt;clearstatcache&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
 
&lt;span style=&#34;color: #000088;&#34;&gt;$local_files&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; getLocalFiles&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$archives_dir&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$date&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #b1b100;&#34;&gt;if&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #990000;&#34;&gt;empty&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$local_files&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39; - Fichiers non présents en local (attention : cela peut venir d\&#39;un problème de droit).&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #b1b100;&#34;&gt;else&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39; - Fichiers présents en local :&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$total_size&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #cc66cc;&#34;&gt;0&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
        &lt;span style=&#34;color: #666666; font-style: italic;&#34;&gt;// affichage de la liste des fichiers avec leur taille et un total global&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;foreach&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$local_files&lt;/span&gt; &lt;span style=&#34;color: #b1b100;&#34;&gt;as&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;   # &#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;name&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
		&lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39; (&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;formatBytes&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;size&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;)&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
		&lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
		&lt;span style=&#34;color: #000088;&#34;&gt;$total_size&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;+=&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$file&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;[&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;size&#39;&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;]&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;   # TOTAL : &#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;formatBytes&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$total_size&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
 
        &lt;span style=&#34;color: #666666; font-style: italic;&#34;&gt;// lance la vérification md5 des fichiers uploadés sur le serveur FTP&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$check_md5_ftp&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; verifMd5Ftp&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$md5_file&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_server&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_name&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$ftp_user_pass&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$filtre_date&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$check_md5_ftp&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;===&lt;/span&gt; &lt;span style=&#34;color: #009900; font-weight: bold;&#34;&gt;false&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39; - problème d\&#39;intégrité dans les fichiers transmis sur le serveur FTP&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
	&lt;span style=&#34;color: #b1b100;&#34;&gt;else&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
		&lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39; - intégrité des fichiers sur le serveur FTP vérifiés.&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#34;&lt;span style=&#34;color: #000099; font-weight: bold;&#34;&gt;\n&lt;/span&gt;&#34;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
	&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
 
&lt;span style=&#34;color: #666666; font-style: italic;&#34;&gt;// construction du sujet du mail&lt;/span&gt;
&lt;span style=&#34;color: #000088;&#34;&gt;$subject&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;[&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$host&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;.&lt;/span&gt;&lt;span style=&#34;color: #0000ff;&#34;&gt;&#39;]&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #b1b100;&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$check_md5_ftp&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;===&lt;/span&gt; &lt;span style=&#34;color: #009900; font-weight: bold;&#34;&gt;true&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$subject&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39; backup ok&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
&lt;span style=&#34;color: #b1b100;&#34;&gt;else&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;{&lt;/span&gt;
	&lt;span style=&#34;color: #000088;&#34;&gt;$subject&lt;/span&gt; &lt;span style=&#34;color: #339933;&#34;&gt;.=&lt;/span&gt; &lt;span style=&#34;color: #0000ff;&#34;&gt;&#39; backup ko&#39;&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #009900;&#34;&gt;}&lt;/span&gt;
 
sendMail&lt;span style=&#34;color: #009900;&#34;&gt;(&lt;/span&gt;&lt;span style=&#34;color: #000088;&#34;&gt;$email_dest&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$subject&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;,&lt;/span&gt; &lt;span style=&#34;color: #000088;&#34;&gt;$output&lt;/span&gt;&lt;span style=&#34;color: #009900;&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color: #339933;&#34;&gt;;&lt;/span&gt;
&lt;span style=&#34;color: #000000; font-weight: bold;&#34;&gt;?&gt;&lt;/span&gt;
</code></pre><p>Vous pouvez copier ce script dans /etc/backup-manager-post.php et lui donner les droits :</p><pre tabindex=0><code>
chmod +x /etc/backup-manager-post.php
</code></pre><p>Pour ajouter le hook à backup-manager, vous devez modifier le fichier de configuration /etc/backup-manager.conf et ajouter :</p><pre tabindex=0><code>
export BM_POST_BACKUP_COMMAND=&#34;/etc/backup-manager-post.php&#34; 
</code></pre></div><footer class=post-footer><ul class=post-tags><li><a href=https://franek.chicour.net/tags/geek/>Geek</a></li><li><a href=https://franek.chicour.net/tags/backup/>Backup</a></li><li><a href=https://franek.chicour.net/tags/backup-manager/>Backup-Manager</a></li><li><a href=https://franek.chicour.net/tags/hook/>Hook</a></li><li><a href=https://franek.chicour.net/tags/linux/>Linux</a></li><li><a href=https://franek.chicour.net/tags/sauvegarde/>Sauvegarde</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://franek.chicour.net/>::franek::</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script></body></html>